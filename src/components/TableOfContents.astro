---
import { generateTOC } from '../utils/generateTOC';
import TOCList from './TOCList.astro';

interface Props {
  content: string;
}

const { content } = Astro.props;
const toc = generateTOC(content);
---

<aside class="toc">
  <div class="toc-header">
    <h3>목차</h3>
  </div>
  <nav class="toc-nav">
    {toc.length > 0 ? (
      <TOCList items={toc} />
    ) : (
      <p class="toc-empty">목차가 없습니다</p>
    )}
  </nav>
</aside>

<script>
  // 스크롤시 현재 섹션 하이라이트
  function updateActiveTOC() {
    const headings = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');
    const tocLinks = document.querySelectorAll('.toc-link');
    
    let current = '';
    headings.forEach((heading) => {
      const rect = heading.getBoundingClientRect();
      if (rect.top <= 100) {
        current = heading.id;
      }
    });

    tocLinks.forEach((link) => {
      link.classList.remove('active');
      if (link.getAttribute('href') === `#${current}`) {
        link.classList.add('active');
      }
    });
  }

  // 부드러운 스크롤
  if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.toc-link').forEach((link) => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const href = link.getAttribute('href');
          if (href) {
            const target = document.querySelector(href);
            if (target) {
              const headerOffset = 100;
              const elementPosition = target.getBoundingClientRect().top;
              const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

              window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
              });
            }
          }
        });
      });

      window.addEventListener('scroll', updateActiveTOC);
      updateActiveTOC();
    });
  }
</script>

<style>
  .toc {
    width: 250px;
    min-width: 250px;
    height: calc(100vh - 80px);
    overflow-y: auto;
    padding: 1.5rem 1rem;
    border-left: 1px solid var(--border-color);
    background: var(--bg-secondary);
    position: sticky;
    top: 80px;
  }

  .toc-header h3 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .toc-nav {
    font-size: 0.85rem;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin-bottom: 0.5rem;
  }

  .toc-link {
    display: block;
    padding: 0.4rem 0.75rem;
    text-decoration: none;
    color: var(--text-secondary);
    border-radius: 4px;
    transition: all 0.2s;
    border-left: 2px solid transparent;
  }

  .toc-link:hover {
    background: var(--bg-primary);
    color: var(--text-primary);
    border-left-color: var(--accent-color);
  }

  .toc-link.active {
    color: var(--accent-color);
    font-weight: 500;
    border-left-color: var(--accent-color);
    background: var(--bg-primary);
  }

  .toc-children {
    margin-left: 1rem;
    margin-top: 0.5rem;
  }

  .toc-empty {
    color: var(--text-secondary);
    font-size: 0.85rem;
    margin: 0;
  }

  @media (max-width: 1024px) {
    .toc {
      display: none;
    }
  }
</style>

