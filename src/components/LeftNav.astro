---
import { getPosts, buildPostTree } from '../utils/getPosts';
import NavItem from './NavItem.astro';

const posts = await getPosts();
const postTree = buildPostTree(posts);
---

<aside class="left-nav">
  <nav class="nav-tree">
    <ul class="nav-list">
      {postTree.map((node) => (
        <NavItem node={node} />
      ))}
    </ul>
  </nav>
</aside>

<script>
  // 현재 경로에 따라 활성화
  function setActiveNav() {
    const currentPath = window.location.pathname.replace(/^\//, '').replace(/\/$/, '');
    const navLinks = document.querySelectorAll('.nav-link');
    
    navLinks.forEach((link) => {
      const href = link.getAttribute('href')?.replace(/^\//, '').replace(/\/$/, '');
      if (href === currentPath) {
        link.classList.add('active');
        // 부모 요소들도 확장
        let parent = link.closest('.nav-item');
        while (parent) {
          const toggle = parent.querySelector('.nav-toggle');
          if (toggle) {
            toggle.classList.add('expanded');
            const children = parent.querySelector('.nav-children');
            if (children) children.classList.add('expanded');
          }
          parent = parent.parentElement?.closest('.nav-item') || null;
        }
      }
    });
  }

  // 토글 기능
  if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      setActiveNav();
      
      document.querySelectorAll('.nav-toggle').forEach((toggle) => {
        toggle.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const item = toggle.closest('.nav-item');
          const children = item?.querySelector('.nav-children');
          if (children) {
            toggle.classList.toggle('expanded');
            children.classList.toggle('expanded');
          }
        });
      });
    });
  }
</script>

<style>
  .left-nav {
    width: 220px;
    min-width: 220px;
    height: calc(100vh - 72px);
    overflow-y: auto;
    padding: 1.75rem 0.75rem;
    border-right: 1px solid color-mix(in srgb, var(--border-color) 60%, transparent);
    background: transparent;
    position: sticky;
    top: 72px;
  }

  .nav-tree {
    width: 100%;
  }

  .nav-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .nav-item {
    margin-bottom: 0.35rem;
  }

  .nav-link-wrapper {
    display: flex;
    align-items: center;
    gap: 0.45rem;
    padding: 0.1rem 0.2rem;
  }

  .nav-toggle {
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: none;
    background: none;
    color: var(--text-secondary);
    font-size: 0.7rem;
    transition: transform 0.2s;
    flex-shrink: 0;
  }

  .nav-toggle.expanded {
    transform: rotate(90deg);
  }

  .nav-toggle:before {
    content: '▶';
  }

  .nav-link {
    flex: 1;
    padding: 0.45rem 0.65rem;
    text-decoration: none;
    color: var(--text-secondary);
    border-radius: 8px;
    font-size: 0.88rem;
    transition: all 0.2s ease;
    display: block;
  }

  .nav-link:hover {
    background: color-mix(in srgb, var(--bg-secondary) 70%, transparent);
    color: var(--text-primary);
  }

  .nav-link.active {
    background: color-mix(in srgb, var(--accent-color) 25%, transparent);
    color: var(--accent-color);
    font-weight: 600;
  }

  .nav-children {
    margin-left: 1.25rem;
    margin-top: 0.2rem;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.25s ease;
  }

  .nav-children.expanded {
    max-height: 2000px;
  }

  .nav-children .nav-list {
    border-left: 1px dashed color-mix(in srgb, var(--border-color) 70%, transparent);
    padding-left: 0.9rem;
  }

  @media (max-width: 1024px) {
    .left-nav {
      display: none;
    }
  }
</style>

